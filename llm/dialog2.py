import streamlit as st
import pandas as pd
import json
import requests
import random
from datetime import datetime

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
st.set_page_config(page_title="–ö–Ω–∏–∂–Ω—ã–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å", layout="wide")

# –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API)
def analyze_query_with_ai(user_input):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –Ω–µ–π—Ä–æ—Å–µ—Ç—å
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏
    """
    # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ –∫ API –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
    # –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É —Å –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–æ–π
    
    prompt = f"""
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–Ω–∏–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ –≤—ã–¥–µ–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏:
    {user_input}
    
    –í–µ—Ä–Ω–∏ JSON:
    {{
        "intent": "recommendation|search|information|other",
        "genres": ["–∂–∞–Ω—Ä1", "–∂–∞–Ω—Ä2"],
        "authors": ["–∞–≤—Ç–æ—Ä1", "–∞–≤—Ç–æ—Ä2"], 
        "themes": ["—Ç–µ–º–∞1", "—Ç–µ–º–∞2"],
        "mood": "—Ä–∞–¥–æ—Å—Ç–Ω—ã–π|–≥—Ä—É—Å—Ç–Ω—ã–π|–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π|–ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π",
        "complexity": "–ª–µ–≥–∫–∏–π|—Å—Ä–µ–¥–Ω–∏–π|—Å–ª–æ–∂–Ω—ã–π",
        "time_period": "—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π|–∫–ª–∞—Å—Å–∏–∫–∞|–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π",
        "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞"
    }}
    """
    
    # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π AI –≤—ã–∑–æ–≤)
    user_lower = user_input.lower()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∂–∞–Ω—Ä—ã
    genres = []
    if any(word in user_lower for word in ['—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫', '–∫–æ—Å–º–æ—Å', '–±—É–¥—É—â']):
        genres.append("—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞")
    if any(word in user_lower for word in ['–¥–µ—Ç–µ–∫—Ç–∏–≤', '–ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω', '—Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω']):
        genres.append("–¥–µ—Ç–µ–∫—Ç–∏–≤")
    if any(word in user_lower for word in ['—Ä–æ–º–∞–Ω', '–ª—é–±–æ–≤', '–æ—Ç–Ω–æ—à–µ–Ω']):
        genres.append("—Ä–æ–º–∞–Ω")
    if any(word in user_lower for word in ['—Ñ—ç–Ω—Ç–µ–∑–∏', '–º–∞–≥–∏', '–≤–æ–ª—à–µ–±']):
        genres.append("—Ñ—ç–Ω—Ç–µ–∑–∏")
    if any(word in user_lower for word in ['–∫–ª–∞—Å—Å–∏–∫', '—Ä—É—Å—Å–∫', '–∑–∞—Ä—É–±–µ–∂']):
        genres.append("–∫–ª–∞—Å—Å–∏–∫–∞")
    
    if not genres:
        genres = ["—Ä–∞–∑–Ω–æ–µ"]
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ
    if any(word in user_lower for word in ['–ø–æ—Å–æ–≤–µ—Ç—É–π', '—Ä–µ–∫–æ–º–µ–Ω–¥', '–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥', '—á—Ç–æ –ø–æ—á–∏—Ç–∞—Ç—å']):
        intent = "recommendation"
    elif any(word in user_lower for word in ['–Ω–∞–π–¥–∏', '–ø–æ–∏—Å–∫', '–∏—â—É', '–≥–¥–µ –Ω–∞–π—Ç–∏']):
        intent = "search"
    else:
        intent = "recommendation"  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    return {
        "intent": intent,
        "genres": genres,
        "authors": [],
        "themes": [],
        "mood": "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π",
        "complexity": "—Å—Ä–µ–¥–Ω–∏–π", 
        "time_period": "—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π",
        "reasoning": f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∂–∞–Ω—Ä—ã: {', '.join(genres)}"
    }

# –ë–∞–∑–∞ –∫–Ω–∏–≥ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
def get_books_database():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –±–∞–∑—É –∫–Ω–∏–≥"""
    return [
        # –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞
        {"id": 1, "title": "–î—é–Ω–∞", "author": "–§—Ä—ç–Ω–∫ –ì–µ—Ä–±–µ—Ä—Ç", "genre": "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞", 
         "year": 1965, "rating": 4.7, "pages": 704, "theme": "–∫–æ—Å–º–æ—Å, –ø–æ–ª–∏—Ç–∏–∫–∞", "complexity": "—Å–ª–æ–∂–Ω—ã–π"},
        {"id": 2, "title": "–ü–∏–∫–Ω–∏–∫ –Ω–∞ –æ–±–æ—á–∏–Ω–µ", "author": "–°—Ç—Ä—É–≥–∞—Ü–∫–∏–µ", "genre": "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞",
         "year": 1972, "rating": 4.6, "pages": 320, "theme": "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è, –∑–∞–≥–∞–¥–∫–∞", "complexity": "—Å—Ä–µ–¥–Ω–∏–π"},
        {"id": 3, "title": "–ò–≥—Ä–∞ –≠–Ω–¥–µ—Ä–∞", "author": "–û—Ä—Å–æ–Ω –°–∫–æ—Ç—Ç –ö–∞—Ä–¥", "genre": "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞",
         "year": 1985, "rating": 4.5, "pages": 384, "theme": "–≤–æ–π–Ω–∞, –¥–µ—Ç–∏", "complexity": "—Å—Ä–µ–¥–Ω–∏–π"},
        
        # –î–µ—Ç–µ–∫—Ç–∏–≤—ã
        {"id": 4, "title": "–£–±–∏–π—Å—Ç–≤–æ –≤ –í–æ—Å—Ç–æ—á–Ω–æ–º —ç–∫—Å–ø—Ä–µ—Å—Å–µ", "author": "–ê–≥–∞—Ç–∞ –ö—Ä–∏—Å—Ç–∏", "genre": "–¥–µ—Ç–µ–∫—Ç–∏–≤",
         "year": 1934, "rating": 4.5, "pages": 320, "theme": "—Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", "complexity": "—Å—Ä–µ–¥–Ω–∏–π"},
        {"id": 5, "title": "–®–µ—Ä–ª–æ–∫ –•–æ–ª–º—Å", "author": "–ê—Ä—Ç—É—Ä –ö–æ–Ω–∞–Ω –î–æ–π–ª", "genre": "–¥–µ—Ç–µ–∫—Ç–∏–≤", 
         "year": 1887, "rating": 4.8, "pages": 280, "theme": "—Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", "complexity": "—Å—Ä–µ–¥–Ω–∏–π"},
        
        # –†–æ–º–∞–Ω—ã
        {"id": 6, "title": "–í–µ–ª–∏–∫–∏–π –ì—ç—Ç—Å–±–∏", "author": "–§—Ä—ç–Ω—Å–∏—Å –°–∫–æ—Ç—Ç –§–∏—Ü–¥–∂–µ—Ä–∞–ª—å–¥", "genre": "—Ä–æ–º–∞–Ω",
         "year": 1925, "rating": 4.3, "pages": 218, "theme": "–ª—é–±–æ–≤—å, –æ–±—â–µ—Å—Ç–≤–æ", "complexity": "—Å—Ä–µ–¥–Ω–∏–π"},
        {"id": 7, "title": "–ì–æ—Ä–¥–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—É–±–µ–∂–¥–µ–Ω–∏–µ", "author": "–î–∂–µ–π–Ω –û—Å—Ç–∏–Ω", "genre": "—Ä–æ–º–∞–Ω",
         "year": 1813, "rating": 4.5, "pages": 432, "theme": "–ª—é–±–æ–≤—å, –æ–±—â–µ—Å—Ç–≤–æ", "complexity": "—Å—Ä–µ–¥–Ω–∏–π"},
        
        # –§—ç–Ω—Ç–µ–∑–∏
        {"id": 8, "title": "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –ö–æ–ª–µ—Ü", "author": "–î–∂. –†. –†. –¢–æ–ª–∫–∏–Ω", "genre": "—Ñ—ç–Ω—Ç–µ–∑–∏",
         "year": 1954, "rating": 4.9, "pages": 1200, "theme": "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è, –º–∞–≥–∏—è", "complexity": "—Å–ª–æ–∂–Ω—ã–π"},
        {"id": 9, "title": "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä", "author": "–î–∂. –ö. –†–æ—É–ª–∏–Ω–≥", "genre": "—Ñ—ç–Ω—Ç–µ–∑–∏",
         "year": 1997, "rating": 4.8, "pages": 320, "theme": "–º–∞–≥–∏—è, —à–∫–æ–ª–∞", "complexity": "–ª–µ–≥–∫–∏–π"},
        
        # –ö–ª–∞—Å—Å–∏–∫–∞
        {"id": 10, "title": "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ", "author": "–§. –ú. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "genre": "–∫–ª–∞—Å—Å–∏–∫–∞",
         "year": 1866, "rating": 4.6, "pages": 672, "theme": "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è, –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ", "complexity": "—Å–ª–æ–∂–Ω—ã–π"},
        {"id": 11, "title": "–í–æ–π–Ω–∞ –∏ –º–∏—Ä", "author": "–õ. –ù. –¢–æ–ª—Å—Ç–æ–π", "genre": "–∫–ª–∞—Å—Å–∏–∫–∞",
         "year": 1869, "rating": 4.7, "pages": 1225, "theme": "–∏—Å—Ç–æ—Ä–∏—è, –æ–±—â–µ—Å—Ç–≤–æ", "complexity": "—Å–ª–æ–∂–Ω—ã–π"},
    ]

# –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
def get_recommendations(analysis_result, books_db):
    """–†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞"""
    
    filtered_books = books_db.copy()
    
    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∂–∞–Ω—Ä–∞–º
    if analysis_result["genres"]:
        filtered_books = [book for book in filtered_books 
                         if book["genre"] in analysis_result["genres"]]
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
    if analysis_result["complexity"] == "–ª–µ–≥–∫–∏–π":
        filtered_books = [book for book in filtered_books if book["pages"] < 400]
    elif analysis_result["complexity"] == "—Å–ª–æ–∂–Ω—ã–π":
        filtered_books = [book for book in filtered_books if book["pages"] >= 400]
    
    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
    filtered_books.sort(key=lambda x: x["rating"], reverse=True)
    
    return filtered_books

# –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
def main():
    st.title("üìö –£–º–Ω—ã–π –∫–Ω–∏–∂–Ω—ã–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å")
    st.markdown("–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ—á–∏—Ç–∞—Ç—å - –Ω–µ–π—Ä–æ—Å–µ—Ç—å –ø–æ–¥–±–µ—Ä–µ—Ç –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã")
    
    # –ü–æ–ª–µ –≤–≤–æ–¥–∞
    user_input = st.text_input(
        "–í–∞—à –∑–∞–ø—Ä–æ—Å:", 
        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫—É –ø—Ä–æ –∫–æ—Å–º–æ—Å'",
        key="user_input"
    )
    
    if user_input:
        with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à –∑–∞–ø—Ä–æ—Å..."):
            # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
            analysis = analyze_query_with_ai(user_input)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            books_db = get_books_database()
            recommendations = get_recommendations(analysis, books_db)
            
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
        st.subheader("üîç –ê–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞")
        col1, col2 = st.columns(2)
        
        with col1:
            st.metric("–ù–∞–º–µ—Ä–µ–Ω–∏–µ", analysis["intent"])
            st.metric("–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∂–∞–Ω—Ä—ã", ", ".join(analysis["genres"]))
        
        with col2:
            st.metric("–°–ª–æ–∂–Ω–æ—Å—Ç—å", analysis["complexity"])
            st.metric("–û–±—ä—è—Å–Ω–µ–Ω–∏–µ", analysis["reasoning"])
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        st.subheader(f"üìñ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–Ω–∏–≥–∏ ({len(recommendations)} –Ω–∞–π–¥–µ–Ω–Ω–æ)")
        
        if recommendations:
            # –°–æ–∑–¥–∞–µ–º DataFrame –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            df = pd.DataFrame(recommendations)
            
            # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            display_columns = ["title", "author", "genre", "year", "rating", "pages"]
            display_df = df[display_columns]
            
            # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            display_df = display_df.rename(columns={
                "title": "–ù–∞–∑–≤–∞–Ω–∏–µ",
                "author": "–ê–≤—Ç–æ—Ä", 
                "genre": "–ñ–∞–Ω—Ä",
                "year": "–ì–æ–¥",
                "rating": "–†–µ–π—Ç–∏–Ω–≥",
                "pages": "–°—Ç—Ä–∞–Ω–∏—Ü"
            })
            
            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
            st.dataframe(
                display_df,
                use_container_width=True,
                height=400
            )
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–∞—Ö
            with st.expander("–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∞—Ö"):
                for book in recommendations[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3
                    st.write(f"**{book['title']}** - {book['author']}")
                    st.write(f"–¢–µ–º—ã: {book['theme']} | –°–ª–æ–∂–Ω–æ—Å—Ç—å: {book['complexity']}")
                    st.progress(book['rating'] / 5, text=f"–†–µ–π—Ç–∏–Ω–≥: {book['rating']}/5")
                    st.divider()
                    
        else:
            st.warning("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É.")

if __name__ == "__main__":
    main()